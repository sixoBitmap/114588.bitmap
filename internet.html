<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bitmap Explorer (ordinals.com)</title>
  <style>
    :root{
      --bg:#0b0e14;
      --panel:#070a10;
      --panel2:#0f1420;
      --line:#232a36;
      --line2:#141a24;
      --text:#e6e6e6;
      --muted:#9aa6b2;
      --pill:#111a2a;
      --accent:#3a4660;
    }
    * { box-sizing: border-box; }
    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      height:100vh;
      overflow:hidden;
    }
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, var(--panel2), var(--bg));
      overflow-x:auto;
      white-space:nowrap;
    }
    .brand{ font-weight:800; letter-spacing:0.2px; margin-right:6px; }
    .btn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ border-color:var(--accent); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .label{
      font-size:12px;
      color:var(--muted);
      margin-left:2px;
    }
    .input{
      width:140px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      outline:none;
    }
    .input.small{ width:90px; }
    .status{
      font-size:12px;
      color:var(--muted);
      margin-left:8px;
      flex:1 1 auto;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      font-size:12px;
      color:#b6c0d0;
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 10px;
      background:var(--panel);
      flex:0 0 auto;
    }

    .main{
      display:grid;
      grid-template-columns: 380px 1fr;
      height: calc(100vh - 56px);
      min-height:0;
    }
    .left{
      border-right:1px solid var(--line);
      display:flex;
      flex-direction:column;
      min-height:0;
      background:var(--bg);
    }
    .tabs{
      display:flex;
      gap:8px;
      padding:10px;
      border-bottom:1px solid var(--line);
      background:var(--bg);
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      cursor:pointer;
    }
    .tab.active{
      background:var(--pill);
      border-color:var(--accent);
    }
    .listWrap{
      flex:1;
      overflow:auto;
      min-height:0;
    }
    .listHeader{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--bg);
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      border-bottom:1px solid var(--line2);
    }
    .listTitle{ font-weight:700; }
    .filter{
      width:160px;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      outline:none;
    }
    .list{
      padding:6px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      margin:6px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:var(--panel);
      cursor:pointer;
    }
    .row:hover{ border-color:var(--accent); }
    .row.active{
      border-color:var(--accent);
      background:#0f1626;
    }
    .rowMain{ font-weight:700; }
    .rowSub{
      font-size:11px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:280px;
    }
    .tag{
      font-size:11px;
      color:#b6c0d0;
      border:1px solid var(--line);
      border-radius:999px;
      padding:2px 8px;
      background: #070a10;
      flex:0 0 auto;
    }
    .listFooter{
      padding:10px;
      border-top:1px solid var(--line2);
      background:var(--bg);
      display:flex;
      gap:8px;
    }

    .right{
      display:flex;
      flex-direction:column;
      min-height:0;
      background:#070a10;
    }
    .viewerTop{
      height:56px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:var(--bg);
      min-height:56px;
      overflow-x:auto;
      white-space:nowrap;
    }
    .selected{ font-weight:700; }
    iframe{
      width:100%;
      height:100%;
      border:0;
      flex:1;
      background:#070a10;
      min-height:0;
    }
    .hint{ margin-left:auto; color:var(--muted); font-size:12px; }
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background:#0f1626;
      border:1px solid var(--accent);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      opacity:0;
      transform: translateY(6px);
      transition: 160ms ease;
      pointer-events:none;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Bitmap Explorer</div>

    <button id="prevBtn" class="btn" title="Prev bitmap">◀</button>
    <button id="nextBtn" class="btn" title="Next bitmap">▶</button>

    <span class="label">bitmap</span>
    <input id="bitmapInput" class="input" type="number" placeholder="e.g. 100" />

    <span class="label">at</span>
    <input id="atInput" class="input small" type="number" value="-1" title="sat index: -1 latest, 0 first, -2 second-latest..." />

    <button id="loadBtn" class="btn">Load</button>

    <div id="status" class="status">Ready.</div>
    <div id="counters" class="pill">reinscriptions: – • children: –</div>
  </div>

  <div class="main">
    <div class="left">
      <div class="tabs">
        <button id="tabRe" class="tab active">Reinscriptions</button>
        <button id="tabCh" class="tab">Children</button>
      </div>

      <div class="listWrap">
        <div class="listHeader">
          <div id="listTitle" class="listTitle">Reinscriptions</div>
          <input id="filterInput" class="filter" type="text" placeholder="filter…" />
        </div>
        <div id="list" class="list"></div>
      </div>

      <div class="listFooter">
        <button id="loadMoreBtn" class="btn" style="flex:1">Load more</button>
      </div>
    </div>

    <div class="right">
      <div class="viewerTop">
        <div id="selectedLabel" class="selected">Selected: –</div>
        <button id="openTabBtn" class="btn">Open in new tab</button>
        <button id="copyBtn" class="btn">Copy id</button>
        <div class="hint">Click a reinscription or child to preview.</div>
      </div>
      <iframe id="viewer" src="about:blank"></iframe>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
(() => {
  const BASE_URL = "https://ordinals.com";

  // --- OCW mapping pages (your library) ---
  const allPages = [
    `${BASE_URL}/content/01bba6c58af39d7f199aa2bceeaaba1ba91b23d2663bc4ef079a4b5e442dbf74i0`,
    `${BASE_URL}/content/bb01dfa977a5cd0ee6e900f1d1f896b5ec4b1e3c7b18f09c952f25af6591809fi0`,
    `${BASE_URL}/content/bb02e94f3062facf6aa2e47eeed348d017fd31c97614170dddb58fc59da304efi0`,
    `${BASE_URL}/content/bb037ec98e6700e8415f95d1f5ca1fe1ba23a3f0c5cb7284d877e9ac418d0d32i0`,
    `${BASE_URL}/content/bb9438f4345f223c6f4f92adf6db12a82c45d1724019ecd7b6af4fcc3f5786cei0`,
    `${BASE_URL}/content/bb0542d4606a9e7eb4f31051e91f7696040db06ca1383dff98505618c34d7df7i0`,
    `${BASE_URL}/content/bb06a4dffba42b6b513ddee452b40a67688562be4a1345127e4d57269e6b2ab6i0`,
    `${BASE_URL}/content/bb076934c1c22007b315dd1dc0f8c4a2f9d52f348320cfbadc7c0bd99eaa5e18i0`,
    `${BASE_URL}/content/bb084ed0d70c336861e794c5a2d41a19df8b5531b51ffe71a868695c20cafed2i0`
  ];

  const pages = Array(allPages.length).fill(null);
  const pagePromises = Array(allPages.length).fill(null);

  // --- UI refs ---
  const prevBtn = $("#prevBtn");
  const nextBtn = $("#nextBtn");
  const loadBtn = $("#loadBtn");
  const bitmapInput = $("#bitmapInput");
  const atInput = $("#atInput");
  const statusEl = $("#status");
  const countersEl = $("#counters");

  const tabRe = $("#tabRe");
  const tabCh = $("#tabCh");
  const listTitle = $("#listTitle");
  const filterInput = $("#filterInput");
  const listEl = $("#list");
  const loadMoreBtn = $("#loadMoreBtn");

  const viewer = $("#viewer");
  const selectedLabel = $("#selectedLabel");
  const openTabBtn = $("#openTabBtn");
  const copyBtn = $("#copyBtn");

  // --- App state ---
  const state = {
    bitmapNumber: null,
    sat: null,
    atIndex: -1,

    activeTab: "reinscriptions",
    filter: "",

    reinscriptions: [],
    reinsMore: false,
    reinsPage: 0,
    reinsTotal: null,

    childrenRootId: null,
    children: [],
    childMore: false,
    childPage: 0,
    childTotal: null,

    selectedId: null,
    selectedUrl: null,

    busy: false
  };

  // --- Events ---
  loadBtn.onclick = () => loadBitmap(number(bitmapInput.value), number(atInput.value, -1));
  prevBtn.onclick = () => { if (state.bitmapNumber != null && state.bitmapNumber > 0) loadBitmap(state.bitmapNumber - 1, number(atInput.value, -1)); };
  nextBtn.onclick = () => { if (state.bitmapNumber != null) loadBitmap(state.bitmapNumber + 1, number(atInput.value, -1)); };

  bitmapInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") loadBtn.click();
  });
  atInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") loadBtn.click();
  });

  tabRe.onclick = () => { setTab("reinscriptions"); };
  tabCh.onclick = () => { setTab("children"); };

  filterInput.oninput = () => {
    state.filter = (filterInput.value || "").trim().toLowerCase();
    renderList();
  };

  loadMoreBtn.onclick = () => fetchMore();

  openTabBtn.onclick = () => {
    if (state.selectedUrl) window.open(state.selectedUrl, "_blank", "noopener,noreferrer");
  };

  copyBtn.onclick = async () => {
    if (!state.selectedId) return;
    try {
      await navigator.clipboard.writeText(state.selectedId);
      toast("Copied id ✅");
    } catch {
      toast("Copy failed");
    }
  };

  // Optional: read URL params ?bm=123&at=-1
  const params = new URLSearchParams(location.search);
  const bm = number(params.get("bm"));
  const at = number(params.get("at"), -1);
  if (Number.isFinite(bm)) {
    bitmapInput.value = String(bm);
    atInput.value = String(at);
    loadBitmap(bm, at);
  }

  // --- Core flow ---
  async function loadBitmap(bitmapNumber, atIndex = -1) {
    if (!Number.isFinite(bitmapNumber) || bitmapNumber < 0) return;
    if (!Number.isFinite(atIndex)) atIndex = -1;
    if (state.busy) return;

    state.busy = true;
    setStatus("Loading bitmap…");
    countersEl.textContent = "reinscriptions: … • children: …";

    try {
      state.bitmapNumber = bitmapNumber;
      state.atIndex = atIndex;
      bitmapInput.value = String(bitmapNumber);
      atInput.value = String(atIndex);

      const sat = await getBitmapSat(bitmapNumber);
      state.sat = sat;

      // Selected id = /r/sat/<sat>/at/<atIndex>
      const atObj = await fetchJSON(`${BASE_URL}/r/sat/${sat}/at/${atIndex}`);
      if (!atObj?.id) throw new Error(`No id returned for /r/sat/${sat}/at/${atIndex}`);
      const selectedId = atObj.id;

      state.selectedId = selectedId;
      state.selectedUrl = `${BASE_URL}/content/${selectedId}`;
      selectAndView(selectedId, state.selectedUrl, true);

      // Load first pages
      const [satPage0, childPage0] = await Promise.all([
        fetchJSON(`${BASE_URL}/r/sat/${sat}`),
        fetchJSON(`${BASE_URL}/r/children/${selectedId}`)
      ]);

      state.reinscriptions = Array.isArray(satPage0?.ids) ? satPage0.ids : [];
      state.reinsMore = Boolean(satPage0?.more);
      state.reinsPage = 0;

      state.childrenRootId = selectedId;
      state.children = Array.isArray(childPage0?.ids) ? childPage0.ids : [];
      state.childMore = Boolean(childPage0?.more);
      state.childPage = 0;

      // Totals (paged count, can be slow on huge sats)
      const [reinsTotal, childTotal] = await Promise.all([
        countPagedIds(`/r/sat/${sat}`),
        countPagedIds(`/r/children/${selectedId}`)
      ]);

      state.reinsTotal = reinsTotal;
      state.childTotal = childTotal;

      countersEl.textContent = `reinscriptions: ${reinsTotal} • children: ${childTotal}`;
      setStatus(`bitmap ${bitmapNumber} • sat ${sat} • at ${atIndex}`);

      renderList();
    } catch (e) {
      console.error(e);
      setStatus("Error: " + String(e));
      countersEl.textContent = "reinscriptions: – • children: –";
    } finally {
      state.busy = false;
    }
  }

  async function fetchMore() {
    if (!state.sat) return;

    try {
      if (state.activeTab === "reinscriptions") {
        if (!state.reinsMore) return;
        setStatus("Loading more reinscriptions…");
        const nextPage = state.reinsPage + 1;
        const data = await fetchJSON(`${BASE_URL}/r/sat/${state.sat}/${nextPage}`);
        const ids = Array.isArray(data?.ids) ? data.ids : [];
        state.reinscriptions.push(...ids);
        state.reinsMore = Boolean(data?.more);
        state.reinsPage = nextPage;
        setStatus("Loaded.");
        renderList();
        return;
      }

      // children tab
      if (!state.childrenRootId || !state.childMore) return;
      setStatus("Loading more children…");
      const nextPage = state.childPage + 1;
      const data = await fetchJSON(`${BASE_URL}/r/children/${state.childrenRootId}/${nextPage}`);
      const ids = Array.isArray(data?.ids) ? data.ids : [];
      state.children.push(...ids);
      state.childMore = Boolean(data?.more);
      state.childPage = nextPage;
      setStatus("Loaded.");
      renderList();
    } catch (e) {
      console.error(e);
      setStatus("Error: " + String(e));
    }
  }

  function selectAndView(id, url, refreshChildrenIfReinscription) {
    state.selectedId = id;
    state.selectedUrl = url;
    selectedLabel.textContent = `Selected: ${shortId(id)}`;
    viewer.src = url;

    if (refreshChildrenIfReinscription) {
      // refresh children list for this reinscription
      refreshChildrenForId(id);
    }
    renderList();
  }

  async function refreshChildrenForId(id) {
    try {
      setStatus("Refreshing children…");
      const data = await fetchJSON(`${BASE_URL}/r/children/${id}`);
      state.childrenRootId = id;
      state.children = Array.isArray(data?.ids) ? data.ids : [];
      state.childMore = Boolean(data?.more);
      state.childPage = 0;

      // total children for this id
      state.childTotal = await countPagedIds(`/r/children/${id}`);
      countersEl.textContent = `reinscriptions: ${state.reinsTotal ?? state.reinscriptions.length} • children: ${state.childTotal ?? state.children.length}`;
      setStatus("Children updated.");
      if (state.activeTab === "children") renderList();
    } catch (e) {
      console.error(e);
      setStatus("Error: " + String(e));
    }
  }

  function setTab(which) {
    state.activeTab = which;
    tabRe.classList.toggle("active", which === "reinscriptions");
    tabCh.classList.toggle("active", which === "children");
    renderList();
  }

  function renderList() {
    listEl.innerHTML = "";

    const items = (state.activeTab === "reinscriptions") ? state.reinscriptions : state.children;
    const titleTxt = (state.activeTab === "reinscriptions")
      ? `Reinscriptions (sat ${state.sat ?? "?"})`
      : `Children (of ${shortId(state.childrenRootId)})`;

    listTitle.textContent = titleTxt;

    const filtered = state.filter ? items.filter(id => id.toLowerCase().includes(state.filter)) : items;

    for (const id of filtered) {
      const row = document.createElement("div");
      row.className = "row" + (id === state.selectedId ? " active" : "");
      row.title = id;

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";
      left.style.minWidth = "0";

      const main = document.createElement("div");
      main.className = "rowMain";
      main.textContent = shortId(id);

      const sub = document.createElement("div");
      sub.className = "rowSub";
      sub.textContent = id;

      left.append(main, sub);

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = "content";

      row.append(left, tag);

      row.onclick = () => {
        const url = `${BASE_URL}/content/${id}`;
        const refreshChildren = (state.activeTab === "reinscriptions");
        selectAndView(id, url, refreshChildren);
      };

      listEl.appendChild(row);
    }

    const more = (state.activeTab === "reinscriptions") ? state.reinsMore : state.childMore;
    loadMoreBtn.disabled = !more;
    loadMoreBtn.textContent = more ? "Load more" : "No more";
  }

  // --- Fetch helpers ---
  async function fetchJSON(url) {
    // Add Accept header for endpoints that might serve HTML elsewhere
    const r = await fetch(url, {
      headers: { "Accept": "application/json" },
      cache: "no-store",
      credentials: "omit",
      referrerPolicy: "no-referrer"
    });
    if (!r.ok) throw new Error(`${r.status} ${r.statusText} for ${url}`);
    return r.json();
  }

  async function countPagedIds(basePath) {
    let total = 0;
    let page = 0;
    while (true) {
      const path = page === 0 ? basePath : `${basePath}/${page}`;
      const data = await fetchJSON(`${BASE_URL}${path}`);
      if (Array.isArray(data?.ids)) total += data.ids.length;
      if (!data?.more) break;
      page += 1;
      if (page > 5000) throw new Error(`Too many pages while counting ${basePath}`);
    }
    return total;
  }

  // --- OCW mapping (bitmap -> sat) ---
  async function getBitmapSat(bitmapNumber) {
    const page = Math.floor(bitmapNumber / 100000);
    const arr = await fillPage(page);
    return arr[bitmapNumber % 100000];
  }

  async function fillPage(page) {
    if (page < 0 || page >= allPages.length) {
      throw new Error(`Bitmap page ${page} out of range (0..${allPages.length - 1})`);
    }
    if (pages[page]) return pages[page];
    if (pagePromises[page]) return pagePromises[page];

    pagePromises[page] = (async () => {
      const text = await retryFetchText(allPages[page], 4);
      const data = parseOCWPageText(text, page);

      if (!Array.isArray(data) || data.length < 2 || !Array.isArray(data[0]) || !Array.isArray(data[1])) {
        throw new Error(`OCW page ${page} parsed into unexpected shape`);
      }

      const deltas = data[0];
      const indexes = data[1];

      const fullSats = new Array(deltas.length);
      for (let i = 0; i < deltas.length; i++) {
        const d = Number(deltas[i]);
        fullSats[i] = (i === 0) ? d : (fullSats[i - 1] + d);
      }

      const filled = Array(100000).fill(0);
      for (let i = 0; i < indexes.length; i++) {
        filled[Number(indexes[i])] = fullSats[i];
      }

      pages[page] = filled;
      return filled;
    })();

    return pagePromises[page];
  }

  async function retryFetchText(url, retries) {
    let lastErr = null;
    for (let i = 0; i <= retries; i++) {
      try {
        const r = await fetch(url, {
          cache: "force-cache",
          credentials: "omit",
          referrerPolicy: "no-referrer"
        });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText} for ${url}`);
        return await r.text();
      } catch (e) {
        lastErr = e;
        const wait = Math.min(2000, 250 * Math.pow(2, i));
        await new Promise(res => setTimeout(res, wait));
      }
    }
    throw lastErr || new Error("retryFetchText failed");
  }

  function parseOCWPageText(text, page) {
    let t = String(text || "").trim().replace(/^\uFEFF/, "");

    // special-case pages 2/3
    if (page === 2 || page === 3) {
      const arr = JSON.parse("[" + t + "]");
      return [arr.slice(0, 99999), arr.slice(100000, 199999)];
    }

    let v = tryJson(t);
    if (typeof v === "string") v = tryJson(v) ?? v;

    if (!isTwoArrayShape(v)) {
      const extracted = extractFirstArrayBlock(t);
      if (extracted) {
        v = tryJson(extracted) ?? v;
        if (typeof v === "string") v = tryJson(v) ?? v;
      }
    }

    if (!isTwoArrayShape(v)) {
      const cut = cutToFirstBracket(t);
      if (cut) {
        v = tryJson(cut) ?? v;
        if (typeof v === "string") v = tryJson(v) ?? v;
      }
    }

    return v;
  }

  function tryJson(s) { try { return JSON.parse(s); } catch { return null; } }
  function isTwoArrayShape(v) { return Array.isArray(v) && v.length >= 2 && Array.isArray(v[0]) && Array.isArray(v[1]); }
  function extractFirstArrayBlock(t) {
    const a = t.indexOf("[");
    const b = t.lastIndexOf("]");
    if (a === -1 || b === -1 || b <= a) return null;
    return t.slice(a, b + 1).replace(/;\s*$/, "");
  }
  function cutToFirstBracket(t) {
    const i = t.indexOf("[");
    if (i === -1) return null;
    return t.slice(i).replace(/;\s*$/, "");
  }

  // --- small utils ---
  function $(sel){ return document.querySelector(sel); }
  function number(v, def){
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  }
  function shortId(id){
    if (!id) return "–";
    return id.slice(0,10) + "…" + id.slice(-4);
  }
  function setStatus(t){ statusEl.textContent = t; }
  function toast(msg){
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 900);
  }
})();
</script>
</body>
</html>
