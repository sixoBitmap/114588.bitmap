<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Magic Cards - Matrix Mode</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #000;
      --text-color: #00ff00;
      --border-color: #00ff00;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background-color: var(--bg-color);
      overflow: hidden;
      transition: background-color 0.2s ease;
    }

    body {
      font-family: 'Orbitron', monospace;
      color: var(--text-color);
      text-shadow: 0 0 8px var(--text-color);
      transition: color 0.2s ease;
    }

    .control-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 1;
      pointer-events: all;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .control-panel.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .input-wrapper {
      position: relative;
      width: 240px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    input {
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      outline: none;
      text-align: center;
      font-size: 1em;
      letter-spacing: 2px;
      font-family: 'Orbitron', monospace;
      text-shadow: 0 0 8px var(--text-color);
      box-sizing: border-box;
      z-index: 2;
    }

    input::placeholder {
      color: #008000;
    }

    .button-ring button {
      position: absolute;
      width: 60px;
      height: 60px;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-size: 1em;
      box-shadow: 0 0 6px var(--border-color);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transform: skewX(-15deg);
      clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%);
    }

    .button-ring button:hover {
      background: var(--text-color);
      color: var(--bg-color);
      box-shadow: 0 0 12px var(--border-color);
      transform: skewX(-15deg) scale(1.05);
    }

    .top-left     { top: -61px; left: -61px; }
    .top-right    { top: -61px; right: -61px; }
    .bottom-left  { bottom: -61px; left: -61px; }
    .bottom-right { bottom: -61px; right: -61px; }
    .top-center-1 { top: -61px; left: 60px; position: relative; }
    .top-center-2 { top: -61px; right: 60px; }
    .bottom-center { bottom: -61px; left: 50%; transform: translateX(-50%) skewX(-15deg); }

    .lock-icon {
      position: absolute;
      top: 4px;
      right: 6px;
      width: 14px;
      height: 14px;
      border: 2px solid #00ff00;
      border-radius: 3px;
      box-shadow: 0 0 6px #00ff00;
      background: transparent;
      z-index: 3;
    }

    .lock-icon::before {
      content: "";
      position: absolute;
      top: -6px;
      left: 3px;
      width: 6px;
      height: 6px;
      border: 2px solid #00ff00;
      border-bottom: none;
      border-radius: 50% 50% 0 0;
      box-shadow: 0 0 6px #00ff00;
    }

    .lock-icon::after {
      content: "";
      position: absolute;
      top: 4px;
      left: 4px;
      width: 2px;
      height: 5px;
      background: #00ff00;
      box-shadow: 0 0 6px #00ff00;
    }

    .matrix-sphere {
      position: absolute;
      width: 65px;
      height: 65px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #001100 0%, #000 70%);
      border: 2px solid #00ff00;
      color: #00ff00;
      font-family: 'Orbitron', monospace;
      font-size: 1.5em;
      cursor: pointer;
      box-shadow: 0 0 20px #00ff00;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .matrix-sphere.hidden {
      display: none;
    }

    .matrix-sphere::before {
      content: var(--matrix-text, " ");
      position: absolute;
      top: -200%;
      left: 0;
      width: 100%;
      height: 300%;
      color: rgba(0, 255, 0, 0.25);
      font-size: 0.8em;
      writing-mode: vertical-rl;
      animation: matrixRain 3s linear infinite;
      pointer-events: none;
      text-align: center;
      word-break: break-all;
    }

    @keyframes matrixRain {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }

    .paste-btn { left: -80px; }
    .restore-btn { right: -80px; }

    iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      border: none;
      transition: opacity 0.3s ease;
      z-index: 1;
    }

    .hidden { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <div class="control-panel" id="controlPanel">
    <div class="input-wrapper">
      <button class="matrix-sphere paste-btn hidden" id="pasteBtn" onclick="pasteCopied()">⧉</button>
      <button class="matrix-sphere restore-btn hidden" id="restoreBtn" onclick="restorePrevious()">⟳</button>
      <input id="inscriptionId" type="text" placeholder="Enter inscription ID..." />

      <div class="button-ring">
        <button class="top-left" onmouseover="hoverDisplay('inscription')" onmouseout="hoverClear()" onclick="buttonAction('inscription','inscription')">#</button>
        <button class="top-right" onmouseover="hoverDisplay('metadata')" onmouseout="hoverClear()" onclick="buttonAction('metadata','metadata')">*</button>
        <button class="bottom-left" onmouseover="hoverDisplay('children')" onmouseout="hoverClear()" onclick="buttonAction('children','children')">.</button>
        <button class="bottom-right" onmouseover="hoverDisplay('parents-inscriptions')" onmouseout="hoverClear()" onclick="buttonAction('parents-inscriptions','parents-inscriptions')">%/#</button>

        <!-- @ button -->
        <button class="top-center-1" onmouseover="hoverDisplay('content')" onmouseout="hoverClear()" onclick="buttonAction('content','content')">
          @
          <span class="lock-icon"></span>
        </button>

        <button class="top-center-2" onmouseover="hoverDisplay('undelegated-content')" onmouseout="hoverClear()" onclick="buttonAction('undelegated-content','undelegated-content')">?</button>
        <button class="bottom-center" onmouseover="hoverDisplay('parents')" onmouseout="hoverClear()" onclick="buttonAction('parents','parents')">%</button>
      </div>
    </div>
  </div>

  <iframe id="resultFrame" title="Ordinal API Output"></iframe>

  <script>
  let lastCopiedText = "";
  let previousInputText = "";
  let originalInputValue = "";
  let inverted = false;

  const panel = document.getElementById("controlPanel");
  const frame = document.getElementById("resultFrame");
  const input = document.getElementById("inscriptionId");
  const pasteBtn = document.getElementById("pasteBtn");
  const restoreBtn = document.getElementById("restoreBtn");

  panel.classList.remove("hidden");
  frame.addEventListener("click", () => panel.classList.toggle("hidden"));

  function updateMatrixSphereText() {
    pasteBtn.style.setProperty("--matrix-text", `"${lastCopiedText}"`);
    restoreBtn.style.setProperty("--matrix-text", `"${previousInputText}"`);
  }

  function pasteCopied() {
    if (lastCopiedText.trim() !== "") {
      previousInputText = input.value;
      input.value = lastCopiedText.trim();
      restoreBtn.classList.remove("hidden");
      updateMatrixSphereText();
    }
  }

  function restorePrevious() {
    if (previousInputText.trim() !== "") {
      input.value = previousInputText;
      previousInputText = "";
      restoreBtn.classList.add("hidden");
      updateMatrixSphereText();
    }
  }

  function hoverDisplay(text) {
    if (!originalInputValue) originalInputValue = input.value;
    input.value = text;
  }

  function hoverClear() {
    input.value = originalInputValue;
    originalInputValue = "";
  }

  async function buttonAction(type, label) {
    panel.classList.add("hidden");
    frame.classList.add("hidden");
    await glitchEffect(500);
    await loadFrame(type, label);
  }

  async function glitchEffect(duration = 500) {
    const root = document.documentElement;
    const start = performance.now();
    const originalFilter = document.body.style.filter;
    const originalTransform = document.body.style.transform;
    while (performance.now() - start < duration) {
      const invertColors = Math.random() > 0.5;
      const skew = (Math.random() - 0.5) * 2;
      const blur = Math.random() * 2;
      const translateX = (Math.random() - 0.5) * 5;
      const translateY = (Math.random() - 0.5) * 5;

      if (invertColors) {
        root.style.setProperty("--bg-color", "#00ff00");
        root.style.setProperty("--text-color", "#000");
        root.style.setProperty("--border-color", "#000");
      } else {
        root.style.setProperty("--bg-color", "#000");
        root.style.setProperty("--text-color", "#00ff00");
        root.style.setProperty("--border-color", "#00ff00");
      }

      document.body.style.filter = `blur(${blur}px)`;
      document.body.style.transform = `skewX(${skew}deg) translate(${translateX}px, ${translateY}px)`;
      await new Promise(res => setTimeout(res, 30 + Math.random() * 50));
    }
    document.body.style.filter = originalFilter;
    document.body.style.transform = originalTransform;
    root.style.setProperty("--bg-color", "#000");
    root.style.setProperty("--text-color", "#00ff00");
    root.style.setProperty("--border-color", "#00ff00");
  }

  async function loadFrame(type, label) {
    const id = input.value.trim();
    if (!id) {
      alert("Please enter an inscription ID.");
      frame.classList.remove("hidden");
      panel.classList.remove("hidden");
      return;
    }

    const urls = {
      content: `https://ordinals.com/content/${id}`,
      children: `https://ordinals.com/r/children/${id}`,
      "undelegated-content": `https://ordinals.com/r/undelegated-content/${id}`,
      inscription: `https://ordinals.com/r/inscription/${id}`,
      metadata: `https://ordinals.com/r/metadata/${id}`,
      parents: `https://ordinals.com/r/parents/${id}`,
      "parents-inscriptions": `https://ordinals.com/r/parents/${id}/inscriptions`,
    };

    const url = urls[type];

    // ✅ If it's @ (content) → open new tab but still show text inside iframe
    if (type === "content") {
      window.open(url, "_blank");
    }

    try {
      const res = await fetch(url);
      const contentType = res.headers.get("content-type") || "";
      const text = await res.text();
      let formattedText = text;

      try {
        const json = JSON.parse(text);
        const jsonString = JSON.stringify(json, null, 2);
        const lines = jsonString.split("\n");
        const keyRegex = /^(\s*)"([^"]+)":/;
        let maxKeyLength = 0;
        lines.forEach(line => {
          const match = keyRegex.exec(line);
          if (match) maxKeyLength = Math.max(maxKeyLength, match[2].length);
        });
        formattedText = lines.map(line => {
          const match = keyRegex.exec(line);
          if (match) {
            const padding = " ".repeat(maxKeyLength - match[2].length);
            return line.replace(keyRegex, `${match[1]}${match[2]}${padding} :`);
          }
          return line;
        }).join("\n");
        formattedText = formattedText
          .replace(/[{}\[\]",]/g, "")
          .split("\n")
          .filter(line => line.trim() !== "")
          .join("\n");
      } catch {
        formattedText = text.replace(/></g, ">\n<").replace(/,/g, ",\n");
      }

      const styledHtml = `
        <html>
        <head>
          <style>
            html, body {
              margin: 0; padding: 0; height: 100%; width: 100%;
              background: black; color: #00ff00;
              font-family: 'Orbitron', monospace;
              display: flex; flex-direction: column;
              align-items: center; justify-content: flex-start;
            }
            .header-box {
              margin-top: 20px;
              padding: 10px 25px;
              background: black;
              border: 1px solid #00ff00;
              color: #00ff00;
              font-size: 1.3em;
              letter-spacing: 2px;
              text-transform: uppercase;
              clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%);
              box-shadow: 0 0 12px #00ff00;
              transform: skewX(-15deg);
              text-shadow: 0 0 10px #00ff00;
            }
            pre {
              white-space: pre-wrap;
              word-break: break-word;
              font-size: 1em;
              text-shadow: 0 0 5px #00ff00;
              line-height: 1.4em;
              max-width: 90%;
            }
          </style>
        </head>
        <body>
          <div class="header-box">${label}</div>
          <pre>${formattedText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
          <script>
            document.addEventListener('copy', () => {
              parent.postMessage({ type: 'showControlPanel', text: window.getSelection().toString() }, '*');
            });
          <\/script>
        </body>
        </html>`;
      const blob = new Blob([styledHtml], { type: "text/html" });
      frame.src = URL.createObjectURL(blob);
    } catch {
      frame.srcdoc = "<body style='background:black;color:lime;font-family:monospace;padding:10px;'>Error loading content</body>";
    }

    setTimeout(() => frame.classList.remove("hidden"), 200);
  }

  window.addEventListener("message", (event) => {
    if (event.data.type === "showControlPanel") {
      panel.classList.remove("hidden");
      lastCopiedText = event.data.text || "";
      updateMatrixSphereText();
      if (lastCopiedText.trim() !== "") {
        pasteBtn.classList.remove("hidden");
        pasteBtn.style.boxShadow = "0 0 40px #00ff00, 0 0 80px #00ff00";
        setTimeout(() => (pasteBtn.style.boxShadow = "0 0 20px #00ff00"), 400);
      }
    }
  });
  </script>
</body>
</html>
